{% extends 'base.html' %}

{% block title %}
  {{ super() }}
  
{% endblock %}

{% block content %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/style_list.css') }}">



<div class="content_list_block">

    <!-- Кнопка для открытия модального окна "payment" -->
    <div class="blocks">
        <div class="total_weight_block">
            <h2>საერთო წონა{{ total_weight }}კგ</h2>
            <button id="openPaymentModal">სტატისტიკა</button>
        </div>
        <div class="filter_block">
            <input type="text" id="filterInput" placeholder="ფილტრის ველი">
            <button onclick="filterData()">ძიება</button>
        </div>
        <div class="manifest_block">
            <button onclick="manifestDownload()">მანიფესტის გადმოწერა</button>
        </div>
    </div>
    


    <div class="blanks_block_">
        <div class="container">
            <div class="number_block_">
                <label>შესავსები</label>
            </div>

            <div class="sender_block">
                <div class="label_block">
                    <label>გამგზავნი:</label>
                </div>
                <div class="sender_fl_block">
                    <label>სახელი/გვარი</label>
                    <input type="text" name="sender_fl">
                </div>
                <div class="sender_phone_block">
                    <label>ტელეფონი</label>
                    <input type="text" name="sender_phone">
                </div>
            </div>

            <div class="recipient_block">
                <div class="label_block">
                    <label>მიმღები:</label>
                </div>
                <div class="recipient_fl_block">
                    <label>სახელი/გვარი</label>
                    <input type="text" name="recipient_fl" >
                </div>
                <div class="recipient_phone_block">
                    <label>ტელეფონი</label>
                    <input type="text" name="recipient_phone">
                </div>
            </div>

            <div class="information_block">
                <div class="label_block">
                    <label>ინფორმაცია:</label>
                </div>
                <div class="passport_block">
                    <label>პასპორტი</label>
                    <input type="text" name="passport">
                </div>
                <div class="city_block">
                    <label>ქალაქი</label>
                    <select name="city" id="city">
                        <option value="TBILISI">TBILISI</option>
                        <option value="BATUMI">BATUMI</option>
                        <option value="KOBULETI">KOBULETI</option>
                        <option value="KUTAISI">KUTAISI</option>
                        <option value="TELAVI">TELAVI</option>
                        <option value="GORI">GORI</option>
                        <option value="ZUGDIDI">ZUGDIDI</option>
                        <option value="POTI">POTI</option>
                        <option value="KHASHURI">KHASHURI</option>
                        <option value="RUSTAVI">RUSTAVI</option>
                        <option value="SAMTREDIA">SAMTREDIA</option>
                        <option value="SENAKI">SENAKI</option>
                        <option value="ZESTAPHONI">ZESTAPHONI</option>
                        <option value="MARNEULI">MARNEULI</option>
                        <option value="AKHALTSIKHE">AKHALTSIKHE</option>
                        <option value="OZURGETI">OZURGETI</option>
                        <option value="KASPI">KASPI</option>
                        <option value="TCHIATURA">TCHIATURA</option>
                        <option value="TSKALTUBO">TSKALTUBO</option>
                        <option value="SAGAREJO">SAGAREJO</option>
                        <option value="GARDABANI">GARDABANI</option>
                        <option value="BORJOMI">BORJOMI</option>
                        <option value="TKIBULI">TKIBULI</option>
                        <option value="KHONI">KHONI</option>
                        <option value="BOLNISI">BOLNISI</option>
                        <option value="AKHALKALAKI">AKHALKALAKI</option>
                        <option value="GURJAANI">GURJAANI</option>
                        <option value="MTSKHETA">MTSKHETA</option>
                        <option value="KVARELI">KVARELI</option>
                        <option value="AKHMETA">AKHMETA</option>
                        <option value="KARELI">KARELI</option>
                        <option value="LANCHKHUTA">LANCHKHUTA</option>
                        <option value="DUSHETI">DUSHETI</option>
                        <option value="SACHKHERE">SACHKHERE</option>
                        <option value="DEDOPLISTSKARO">DEDOPLISTSKARO</option>
                        <option value="LAGODEKHI">LAGODEKHI</option>
                        <option value="NINOTSMINDA">NINOTSMINDA</option>
                        <option value="ABASHA">ABASHA</option>
                        <option value="TSNORI">TSNORI</option>
                        <option value="TERJOBA">TERJOBA</option>
                        <option value="MARTVILI">MARTVILI</option>
                        <option value="KHOBI">KHOBI</option>
                        <option value="TSALENJIKHA">TSALENJIKHA</option>
                        <option value="VANI">VANI</option>
                        <option value="BAGDADI">BAGDADI</option>
                        <option value="VALE">VALE</option>
                        <option value="CHKHOROTSKU">CHKHOROTSKU</option>
                        <option value="TETRITSQARO">TETRITSQARO</option>
                        <option value="DMANISI">DMANISI</option>
                        <option value="ONI">ONI</option>
                        <option value="TSALKA">TSALKA</option>
                        <option value="AMBROLAURI">AMBROLAURI</option>
                        <option value="SIGNAGI">SIGNAGI</option>
                        <option value="TSAGERI">TSAGERI</option>
                        <option value="JVARI">JVARI</option>
    
    
                        <!-- Добавьте остальные города в том же формате -->
                    </select>
                </div>
                <div class="cost_block">
                    <label>ღირებულება</label>
                    <input type="text" id="numericInput" oninput="sanitizeInput(this)" name="cost">
                </div>
            </div>

            <div class="weights_comment_block">
                <div class="label_block">
                    <label>დეტალები:</label>
                </div>
                <div class="weights_block">
                    <label>წონები</label>
                    <input type="text" name="weights" id="weightsInput" oninput="weightsInputHandler(this)">
                </div>
                <div class="comment_block">
                    <label>კომენტარი</label>
                    <input type="text" name="comment">
                </div>
            </div>

            <div class="payment_block">
                <div class="label_block">
                    <label>გადახდა:</label>
                </div>
                <div class="payment_value_block">
                    <label>გადახდა</label>
                    <input type="text" id="numericInput" name="payment" oninput="sanitizeInput(this)">
                </div>


                    <div class="border_block_">
                        <label class="radio-label">
                            <input type="radio" name="payment_status" value="paid">
                            <span class="radio-custom">
                                <img src="/static/images/paid cash.png" alt="Картинка">
                            </span>
                        </label>

                        <label class="radio-label">
                            <input type="radio" name="payment_status" value="card">
                            <span class="radio-custom">
                                <img src="/static/images/paid card.png" alt="Картинка">
                            </span>
                        </label>

                        <label class="radio-label">
                            <input type="radio" name="payment_status" value="not_paid">
                            <span class="radio-custom">
                                <img src="/static/images/not paid.png" alt="Картинка">
                            </span>
                        </label>
                    </div>


                    <div class="border_block_">
                        <label class="radio-label">
                            <input type="radio" name="payment_currency" value="GEL">
                            <span class="radio-custom">
                                <span class="radio-label-text">₾</span>
                            </span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="payment_currency" value="RUB">
                            <span class="radio-custom">
                                <span class="radio-label-text">₽</span>
                            </span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="payment_currency" value="EUR">
                            <span class="radio-custom">
                                <span class="radio-label-text">€</span>
                            </span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="payment_currency" value="USD">
                            <span class="radio-custom">
                                <span class="radio-label-text">$</span>
                            </span>
                        </label>
                    </div>
                </div>      
            </div>
        </div>

    <button type="button" id="add">დამატება</button>


{% for item in data %}


<div class="blanks_block" data-item="{{ item.number }}" data-weights="{{ item.weights}}">
    <div class="number_block" data-item="{{ item.number }}">
        <label class="{% if item.added_to_the_manifest == 'yes' %}yellow-text{% else %}black-text{% endif %}">
            {% if city_param == 'Москва' %}
                {{ item.number }}
            {% else %}
                {% if item.number < 0 %}00{% else %}0{% endif %}{{ item.number }}
            {% endif %}
        </label>
    </div>


    <div class="sender_block">
        <div class="label_block">
            <label>გამგზავნი:</label>
        </div>
        <div class="sender_fl_block">
            <label>სახელი/გვარი</label>
            <input type="text" value="{{ item.sender_fio }}" readonly>
        </div>
        <div class="sender_phone_block">
            <label>ტელეფონი</label>
            <input type="text" value="{{ item.sender_phone }}" readonly>
        </div>
    </div>

    <div class="recipient_block">
        <div class="label_block">
            <label>მიმღები:</label>
        </div>
        <div class="recipient_fl_block">
            <label>სახელი/გვარი</label>
            <input type="text" value="{{ item.recipient_fio }}" readonly>
        </div>
        <div class="recipient_phone_block">
            <label>ტელეფონი</label>
            <input type="text" value="{{ item.recipient_phone }}" readonly>
        </div>
    </div>

    <div class="information_block">
        <div class="label_block">
            <label>ინფორმაცია:</label>
        </div>
        <div class="passport_block">
            <label>პასპორტი</label>
            <input type="text" value="{{ item.passport }}" readonly>
        </div>
        <div class="city_block">
            <label>ქალაქი</label>
            <input type="text" value="{{ item.city }}" readonly>
        </div>
        <div class="cost_block">
            <label>ღირებულება</label>
            <input type="text" value="{{ item.price }}" id="numericInput" oninput="sanitizeInput(this)" readonly>
        </div>
    </div>

    <div class="weights_comment_block">
        <div class="label_block">
            <label>დეტალები:</label>
        </div>
        <div class="weights_block">
            <label>წონები</label>
            <input type="text" value="{{ item.weights }}" readonly id="weightsInput" oninput="weightsInputHandler(this)">
        </div>
        <div class="comment_block">
            <label>კომენტარი</label>
            <input type="text" value="{{ item.comment }}" readonly>
        </div>
    </div>

    <div class="payment_block">
        <div class="label_block">
            <label>გადახდა:</label>
        </div>
        <div class="payment_value_block">
            <label>გადახდა</label>
            <input type="text" value="{{ item.cost }}" id="numericInput" oninput="sanitizeInput(this)" readonly>
        </div>

        <div class="border_block">
                <label class="radio-label">
                    <input type="radio" name="payment_status_{{ item.id }}" value="paid" {% if item.payment_status == 'paid' %} checked {% endif %} disabled>
                    <span class="radio-custom">
                        <img src="/static/images/paid cash.png" alt="Картинка">
                    </span>
                </label>

                <label class="radio-label">
                    <input type="radio" name="payment_status_{{ item.id }}" value="card" {% if item.payment_status == 'card' %} checked {% endif %} disabled>
                    <span class="radio-custom">
                        <img src="/static/images/paid card.png" alt="Картинка">
                    </span>
                </label>

                <label class="radio-label">
                    <input type="radio" name="payment_status_{{ item.id }}" value="not_paid" {% if item.payment_status == 'not_paid' %} checked {% endif %} disabled>
                    <span class="radio-custom">
                        <img src="/static/images/not paid.png" alt="Картинка">
                    </span>
                </label>
        </div>

        <div class="border_block_">
                <label class="radio-label">
                    <input type="radio" name="payment_currency_{{ item.id }}" value="GEL" {% if item.currency == 'GEL' %} checked {% endif %} disabled>
                    <span class="radio-custom">
                        <span class="radio-label-text">₾</span>
                    </span>
                </label>
                <label class="radio-label">
                    <input type="radio" name="payment_currency_{{ item.id }}" value="RUB" {% if item.currency == 'RUB' %} checked {% endif %} disabled>
                    <span class="radio-custom">
                        <span class="radio-label-text">₽</span>
                    </span>
                </label>
                <label class="radio-label">
                    <input type="radio" name="payment_currency_{{ item.id }}" value="EUR" {% if item.currency == 'EUR' %} checked {% endif %} disabled>
                    <span class="radio-custom">
                        <span class="radio-label-text">€</span>
                    </span>
                </label>
                <label class="radio-label">
                    <input type="radio" name="payment_currency_{{ item.id }}" value="USD" {% if item.currency == 'USD' %} checked {% endif %} disabled>
                    <span class="radio-custom">
                        <span class="radio-label-text">$</span>
                    </span>
                </label>
        </div>

    </div>
</div>


{% endfor %}

</div>


<div class="scroll_block">
    <!-- Вставьте вашу фотографию здесь -->
    <img src="/static/images/up.png" alt="ზემოთ" id="scrollToTopButton">
</div>

<div id="EditModal" class="modal-edit">
    <div class="modal-content">
        <span class="close" onclick="closeEditModal()">&times;</span>
        <h2>მონაცემების რედაქტირება</h2>
        <div id="edit-modal-data"></div>
        <div class="modal_buttons_block">
            <button onclick="saveChanges()">შენახვა</button>
            <button onclick="deleteNumber()">წაშლა</button>
        </div>  
    </div>
</div>


<!-- Модальное окно "payment" -->
<div id="PaymentModal" class="modal_statistic">
    <div class="modal_statistic-content">
        <span class="close" id="closePaymentModal">&times;</span>
        <h2>სტატისტიკა</h2>
                <div class="diagram_box_block">
                    <div class="diagram_block">
                        <canvas id="gelChartCanvas"></canvas>
                    </div>
                    <div class="diagram_block_four">
                        <canvas id="rubChartCanvas"></canvas>
                    </div>

                    <div class="diagram_block_two">
                        <canvas id="usdChartCanvas"></canvas>
                    </div>
                    <div class="diagram_block_three">
                        <canvas id="eurChartCanvas"></canvas>
                    </div>
                </div>
        <!-- Здесь вы можете добавить содержимое вашего модального окна "payment" -->
    </div>
</div>





<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>


<script>
// Получаем значение параметра "date" из URL
const urlParams = new URLSearchParams(window.location.search);
const dateParam = urlParams.get('date');
const cityParam = urlParams.get('where_from'); // Получаем значение параметра "city"

// Используем значение dateParam и cityParam по вашим потребностям
console.log('Выбранная дата:', dateParam);
console.log('Выбранный город:', cityParam);

$(document).ready(function() {
    $("#add").click(function() {
        // Получить значения из полей
        var senderFl = $("input[name='sender_fl']").val();
        var senderPhone = $("input[name='sender_phone']").val();
        var recipientFl = $("input[name='recipient_fl']").val();
        var recipientPhone = $("input[name='recipient_phone']").val();
        var passport = $("input[name='passport']").val();
        var city = $("select[name='city']").val();
        var price = $("input[name='cost']").val();
        var weights = $("input[name='weights']").val();
        var comment = $("input[name='comment']").val();
        var payment = $("input[name='payment']").val();
        var paymentStatus = $("input[name='payment_status']:checked").val();
        var paymentCurrency = $("input[name='payment_currency']:checked").val();


        

// Функция для проверки поля на пустоту и подсветки его красным при ошибке
function validateAndHighlightField(fieldName) {
    var fieldValue = $(fieldName).val();
    if (fieldValue === "") {
        $(fieldName).css("box-shadow", "0 0 10px red");
        setTimeout(function() {
            $(fieldName).css("box-shadow", "0px 0px 10px rgba(0, 0, 0, 0.596)"); // Удалить красную подсветку через 2 секунды
        }, 2000);
        return false;
    } else {
        $(fieldName).css("box-shadow", "0px 0px 10px rgba(0, 0, 0, 0.596)");
        return true;
    }
}


// Проверить, что обязательные поля не пусты
var isValid = true;

isValid = validateAndHighlightField("input[name='passport']") && isValid;
isValid = validateAndHighlightField("input[name='recipient_fl']") && isValid;
isValid = validateAndHighlightField("input[name='recipient_phone']") && isValid;
isValid = validateAndHighlightField("input[name='weights']") && isValid;
isValid = validateAndHighlightField("input[name='payment']") && isValid;
isValid = validateAndHighlightField("input[name='cost']") && isValid;

if (!isValid) {
    showMessage('გთხოვთ შეავსოთ სავალდებულო ველები!', false);
    return; // Остановить отправку формы
}


        // Создать объект formData
        var formData = {
            sender_fl: senderFl,
            sender_phone: senderPhone,
            recipient_fl: recipientFl,
            recipient_phone: recipientPhone,
            passport: passport,
            city: city,
            price: price,
            weights: weights,
            comment: comment,
            payment: payment,
            payment_status: paymentStatus,
            payment_currency: paymentCurrency,
            date: dateParam,
            where_from: cityParam
        };


$.ajax({
    type: "POST",
    url: "/add_to_the_list",  // Замените на адрес вашего обработчика
    data: JSON.stringify(formData),
    contentType: "application/json; charset=utf-8",
    dataType: "json",
    success: function(response) {
        // Обработайте успешный ответ с сервера, если необходимо
        console.log(response);

        if (response.success) {
            // Если сервер вернул True, перезагрузите страницу
            window.location.reload();
        } else {
            // Если сервер вернул False, покажите сообщение
            showMessage(response.message, false);
        }
    },
    error: function(error) {
        // Обработайте ошибку, если необходимо
        console.error(error);
    }
});
    });
});
</script>



<script>
// Функция для скрытия не выбранных радио кнопок при загрузке страницы
function hideUnselectedRadios() {
    var radioGroups = document.querySelectorAll(".border_block input[type='radio']");
    radioGroups.forEach(function(radio) {
        if (!radio.checked) {
            radio.parentNode.style.display = "none";
        }
    });
}

// Вызываем функцию hideUnselectedRadios при загрузке страницы
window.addEventListener('load', hideUnselectedRadios);

// Остальной ваш скрипт...
</script>








<script>
// Открытие модального окна и копирование данных
function openModalWithData(item) {
    var modal = document.getElementById("EditModal");
    var modalData = document.getElementById("edit-modal-data");

    // Получаем значение атрибута data-item
    var itemId = item.getAttribute("data-item");

    // Клонируем блок данных из .blanks_block
    var itemClone = item.cloneNode(true);

    // Разрешаем радио кнопки для редактирования
    var radioButtons = itemClone.querySelectorAll("input[type='radio']");
    radioButtons.forEach(function(radioButton) {
        radioButton.removeAttribute("disabled");
        // Делаем радио кнопки видимыми
        radioButton.parentNode.style.display = "block";
    });

    // Убираем атрибут readonly для всех полей ввода
    var inputFields = itemClone.querySelectorAll("input");
    inputFields.forEach(function(inputField) {
        inputField.removeAttribute("readonly");
    });

    modalData.innerHTML = "";
    modalData.appendChild(itemClone);

    // Добавляем значение data-item как атрибут data-id для элемента modalData
    modalData.setAttribute("data-id", itemId);

    modal.style.display = "block";
}

// Закрытие модального окна
function closeEditModal() {
    var modal = document.getElementById("EditModal");
    modal.style.display = "none";

    
    
}

// Обработчик события keydown для клавиши "Esc"
window.addEventListener("keydown", function(event) {
    if (event.key === "Escape") {
        closeEditModal();
    }
});

// Закрытие модального окна при клике вне окна
window.addEventListener("click", function(event) {
    var modal = document.getElementById("EditModal");
    if (event.target === modal) {
        closeEditModal();
    }
});

// Обработчик события для открытия модального окна при клике на .number_block
var numberBlocks = document.querySelectorAll(".number_block");
numberBlocks.forEach(function(numberBlock) {
    numberBlock.addEventListener("click", function() {
        // Находим ближайший родительский элемент с классом .blanks_block
        var blanksBlock = numberBlock.closest(".blanks_block");
        
        // Передаем данные из .blanks_block в функцию открытия модального окна
        openModalWithData(blanksBlock);
    });
});





// Функция сохранения изменений
function saveChanges() {
    var modalData = document.getElementById("edit-modal-data");
    var itemId = modalData.getAttribute("data-id"); // Получаем идентификатор элемента из атрибута data-id

    // Получите новые данные из модального окна
    var newSenderFIO = modalData.querySelector('.sender_fl_block input').value;
    var newSenderPhone = modalData.querySelector('.sender_phone_block input').value;
    var newRecipientFIO = modalData.querySelector('.recipient_fl_block input').value;
    var newRecipientPhone = modalData.querySelector('.recipient_phone_block input').value;

    var newPassport = modalData.querySelector('.passport_block input').value;
    var newCity = modalData.querySelector('.city_block input').value;
    var newCost = modalData.querySelector('.cost_block input').value;
    var newWeights = modalData.querySelector('.weights_block input').value;
    var newComment = modalData.querySelector('.comment_block input').value;
    var newPayment = modalData.querySelector('.payment_value_block input').value;
    var newPaymentStatus = modalData.querySelector('.border_block input:checked').value;
    var newCurrency = modalData.querySelector('.border_block_ input:checked').value;
    var dateParam = urlParams.get('date');
    var cityParam = urlParams.get('where_from');
    
    var numberBlock = document.querySelector('.number_block');
    var labelText = numberBlock.querySelector('label').textContent;


    // ... продолжайте для других полей

    // Создайте объект с новыми данными
    var newData = {
        item_id: itemId, // Передаем идентификатор элемента
        sender_fio: newSenderFIO,
        sender_phone: newSenderPhone,
        recipient_fio: newRecipientFIO,
        recipient_phone: newRecipientPhone,
        passport: newPassport,
        city: newCity,
        cost: newCost,
        weights: newWeights,
        comment: newComment,
        payment: newPayment,
        payment_status: newPaymentStatus,
        currency: newCurrency,
        date: dateParam,
        where_from: cityParam,
        // ... продолжайте для других полей
    };

    var xhr = new XMLHttpRequest();
xhr.open("POST", "/edit-the-list", true);
xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
xhr.onreadystatechange = function () {
    if (xhr.readyState === 4) {
        if (xhr.status === 200) {
            // Обработайте успешный ответ сервера
            closeEditModal(); // Закрываем модальное окно после успешного сохранения
            window.location.reload();
        } else if (xhr.status === 400) {
            // Обработка ошибки
            var response = JSON.parse(xhr.responseText);
            console.error('Ошибка при сохранении данных на сервере:', response.message);
            // Отобразите сообщение об ошибке на странице
            showMessage(response.message, false);
        }
    }
};
xhr.send(JSON.stringify(newData));

}
</script>

















<!-- Скрипты для модального окна "payment" -->
<script>
    // Обработчик для кнопки открытия модального окна "payment"
    document.getElementById("openPaymentModal").addEventListener("click", function() {
        document.getElementById("PaymentModal").style.display = "block";
    });

    // Обработчик для кнопки закрытия модального окна "payment"
    document.getElementById("closePaymentModal").addEventListener("click", function() {
        document.getElementById("PaymentModal").style.display = "none";
    });

    // Обработчик для закрытия модального окна при клике вне окна
    window.addEventListener("click", function(event) {
        var modal = document.getElementById("PaymentModal");
        if (event.target === modal) {
            modal.style.display = "none";
        }
    });

    // Обработчик для закрытия модального окна при нажатии клавиши "Esc"
    window.addEventListener("keydown", function(event) {
        var modal = document.getElementById("PaymentModal");
        if (event.key === "Escape" && modal.style.display === "block") {
            modal.style.display = "none";
        }
    });
</script>





<script>
    var gelPaid = parseFloat("{{ gel_paid }}");
    var gelCard = parseFloat("{{ gel_card }}");
    var gelNotPaid = parseFloat("{{ gel_not_paid }}");

    var ctx = document.getElementById('gelChartCanvas').getContext('2d');
    
    var options = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                labels: {
                    color: '#d2d2d2'
                }
            }
        },
        scales: {
            x: {
                ticks: {
                    color: '#d2d2d2'
                }
            },
            y: {
                ticks: {
                    color: '#d2d2d2'
                }
            }
        }
    };

    var data = {
        labels: ['ნაღდი', 'ბარათით', 'გადასახდელი'],
        datasets: [{
            label: 'ლარი',
            data: [gelPaid, gelCard, gelNotPaid],
            backgroundColor: ['#e3f707', '#00c2fc', '#fc004c']
        }]
    };

    var gelChart = new Chart(ctx, {
        type: 'bar', // Изменили тип диаграммы на 'bar'
        data: data,
        options: options
    });
</script>


<script>
    var rubPaid = parseFloat("{{ rub_paid }}");
    var rubCard = parseFloat("{{ rub_card }}");
    var rubNotPaid = parseFloat("{{ rub_not_paid }}");

    var ctxRub = document.getElementById('rubChartCanvas').getContext('2d');
    
    var optionsRub = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                labels: {
                    color: '#d2d2d2'
                }
            }
        },
        scales: {
            x: {
                ticks: {
                    color: '#d2d2d2'
                }
            },
            y: {
                ticks: {
                    color: '#d2d2d2'
                }
            }
        }
    };

    var dataRub = {
        labels: ['ნაღდი', 'ბარათით', 'გადასახდელი'],
        datasets: [{
            label: 'რუბლი',
            data: [rubPaid, rubCard, rubNotPaid],
            backgroundColor: ['#e3f707', '#00c2fc', '#fc004c']
        }]
    };

    var rubChart = new Chart(ctxRub, {
        type: 'bar',
        data: dataRub,
        options: optionsRub
    });
</script>



<script>
    var usdPaid = parseFloat("{{ usd_paid }}");
    var usdCard = parseFloat("{{ usd_card }}");
    var usdNotPaid = parseFloat("{{ usd_not_paid }}");

    var ctxUSD = document.getElementById('usdChartCanvas').getContext('2d');
    
    var optionsUSD = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                labels: {
                    color: '#d2d2d2'
                }
            }
        },
        scales: {
            x: {
                ticks: {
                    color: '#d2d2d2'
                }
            },
            y: {
                ticks: {
                    color: '#d2d2d2'
                }
            }
        }
    };

    var dataUSD = {
        labels: ['ნაღდი', 'ბარათით', 'გადასახდელი'],
        datasets: [{
            label: 'დოლარი',
            data: [usdPaid, usdCard, usdNotPaid],
            backgroundColor: ['#e3f707', '#00c2fc', '#fc004c']
        }]
    };

    var usdChart = new Chart(ctxUSD, {
        type: 'bar',
        data: dataUSD,
        options: optionsUSD
    });
</script>



<script>
    var eurPaid = parseFloat("{{ eur_paid }}");
    var eurCard = parseFloat("{{ eur_card }}");
    var eurNotPaid = parseFloat("{{ eur_not_paid }}");

    var ctxEUR = document.getElementById('eurChartCanvas').getContext('2d');
    
    var optionsEUR = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                labels: {
                    color: '#d2d2d2'
                }
            }
        },
        scales: {
            x: {
                ticks: {
                    color: '#d2d2d2'
                }
            },
            y: {
                ticks: {
                    color: '#d2d2d2'
                }
            }
        }
    };

    var dataEUR = {
        labels: ['ნაღდი', 'ბარათით', 'გადასახდელი'],
        datasets: [{
            label: 'ევრო',
            data: [eurPaid, eurCard, eurNotPaid],
            backgroundColor: ['#e3f707', '#00c2fc', '#fc004c']
        }]
    };

    var eurChart = new Chart(ctxEUR, {
        type: 'bar',
        data: dataEUR,
        options: optionsEUR
    });
</script>



<script>
    // Функция для отправки AJAX-запроса на сервер для удаления элемента
    function deleteNumber() {
    // Всплывающее окно с предупреждением
    var confirmation = confirm("ნამდვილად გსურთ ამანათის წაშლა?");

    // Если пользователь подтвердил удаление
    if (confirmation) {
        var modalData = document.getElementById("edit-modal-data");
        var itemId = modalData.getAttribute("data-id"); // Получаем идентификатор элемента из атрибута data-id
        var dateParam = urlParams.get('date');
        var cityParam = urlParams.get('where_from');

        // Создаем объект XMLHttpRequest для отправки запроса
        var xhr = new XMLHttpRequest();

        // Устанавливаем метод и URL для запроса
        xhr.open("POST", "/deleted_from_list", true);

        // Устанавливаем заголовок Content-Type для отправки данных в формате JSON
        xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

        // Создаем объект данных для отправки на сервер
        var data = {
            itemId: itemId,
            dateParam: dateParam,
            cityParam: cityParam
        };

        // Преобразуем объект данных в формат JSON
        var jsonData = JSON.stringify(data);

        // Устанавливаем обработчик события успешного завершения запроса
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4 && xhr.status === 200) {
                // Обработка успешного ответа от сервера
                var response = JSON.parse(xhr.responseText);
                if (response.success) {
                    showMessage(response.message, response.success);
                    // Можете выполнить какие-либо действия, например, обновить страницу
                    location.reload();
                } else {
                    // Обработка ошибки, если не удалось удалить элемент
                    showMessage(response.message, response.success);
                }
            }
        };

        // Отправляем запрос на сервер
        xhr.send(jsonData);
    }
}
</script>


<script>
    function sanitizeInput(input) {
    // Заменяем все нецифровые символы на пустую строку
    input.value = input.value.replace(/\D/g, '');
}
</script>



<script>
    function weightsInputHandler(input) {
        // Получаем значение из поля ввода
        var value = input.value;
    
        // Заменяем запятую на точку
        value = value.replace(',', '.');
    
        // Оставляем только цифры, точку и пробелы
        value = value.replace(/[^0-9.\s]/g, '');
    
        // Устанавливаем очищенное значение обратно в поле ввода
        input.value = value;
    }
</script>
    


<script>
// Получаем все элементы с классом "blanks_block"
var blanksBlocks = document.querySelectorAll(".blanks_block");

// Перебираем каждый элемент
blanksBlocks.forEach(function(blanksBlock) {
    // Получаем значение из атрибута "data-weights"
    var itemWeights = blanksBlock.getAttribute("data-weights");

    // Используем регулярное выражение для разделения чисел
    var weightsArray = itemWeights.split(/\s+/).filter(Boolean); // Разделение по одному или более пробелу и удаление пустых значений

    // Заменяем запятые на точки и вычисляем сумму чисел
    var sum = 0;
    for (var i = 0; i < weightsArray.length; i++) {
        var weight = weightsArray[i].replace(",", ".");
        sum += parseFloat(weight);
    }

    // Если сумма больше или равна 30, добавляем класс
    if (sum >= 30.0) {
        blanksBlock.classList.add("red_blanks_block");
    }
});
</script>


<script>
    // Находим элемент фотографии
var scrollToTopButton = document.getElementById("scrollToTopButton");

// Добавляем обработчик события для клика
scrollToTopButton.addEventListener("click", function() {
    // Прокручиваем страницу наверх
    window.scrollTo({ top: 0, behavior: "smooth" });
});
</script>







<!-- фильтр -->
<script>
// Обработчик события keydown для поля ввода
document.getElementById("filterInput").addEventListener("keydown", function(event) {
    if (event.key === "Enter") {
        filterData(); // Вызываем функцию filterData() при нажатии Enter
    }
});

function filterData() {
    var filterValue = document.getElementById("filterInput").value.toLowerCase(); // Получаем значение из поля ввода и приводим его к нижнему регистру

    // Находим все элементы с классом "blanks_block"
    var blanksBlocks = document.querySelectorAll(".blanks_block");

    // Флаг для отслеживания наличия совпадения
    var foundMatch = false;

    // Создаем регулярное выражение для поиска слова целиком
    var regex = new RegExp("\\b" + filterValue + "\\b");

    // Перебираем найденные элементы
    for (var i = 0; i < blanksBlocks.length; i++) {
        var item = blanksBlocks[i];
        
        // Получаем значения всех полей, которые хотим учитывать
        var senderFIO = item.querySelector(".sender_fl_block input").value.toLowerCase();
        var recipientFIO = item.querySelector(".recipient_fl_block input").value.toLowerCase();
        var passport = item.querySelector(".passport_block input").value.toLowerCase();
        var number = item.querySelector(".number_block label").textContent.toLowerCase(); // Для номера

        // Сравниваем значения полей с введенным значением фильтра, используя регулярное выражение
        if (
            regex.test(senderFIO) ||
            regex.test(recipientFIO) ||
            regex.test(passport) ||
            regex.test(number)
        ) {
            // Найдено совпадение, прокручиваем страницу к этому элементу
            item.scrollIntoView({ behavior: "smooth" });
            // Выделяем элемент
            item.style.backgroundColor = "#353745";

            // Устанавливаем флаг в true для остановки поиска после первого совпадения
            foundMatch = true;

            // Устанавливаем таймер для снятия выделения через 2 секунды
            setTimeout(function(element) {
                element.style.backgroundColor = ""; // Снимаем выделение
            }, 2000, item);

            // Выход из цикла после первого совпадения
            break;
        }
    }

    // Если не найдено совпадений, снимаем выделение с предыдущего совпадения (если оно было)
    if (!foundMatch) {
        var highlightedItems = document.querySelectorAll(".blanks_block[style='background-color: #353745;']");
        highlightedItems.forEach(function (highlightedItem) {
            highlightedItem.style.backgroundColor = "";
        });
    }
}
</script>



<script>
    const whereFrom = urlParams.get('where_from');


    // Определяем аббревиатуру на основе значения "whereFrom"
    let abbreviation = "";
    if (whereFrom === "Санкт-Петербург") {
        abbreviation = "С.П.Б";
    } else if (whereFrom === "Москва") {
        abbreviation = "МСК";
    }

    // Добавляем значение "where_from" к заголовку страницы с аббревиатурой
    if (whereFrom) {
        document.title = `${abbreviation}-ს ბლანკი`;
    }
</script>


<script>
    function manifestDownload() {
        // Получаем строку запроса из текущего URL
        var queryString = window.location.search;

        // Создаем объект URLSearchParams из строки запроса
        var urlParams = new URLSearchParams(queryString);

        // Извлекаем значения параметров из URL
        var date = urlParams.get('date');
        var where_from = urlParams.get('where_from');

        // Показываем всплывающее окно с подтверждением
        var userConfirmed = confirm("თქვენ მართლა გსურთ მანიფესტის გადმოწერა? თუ არ იცით რას აკეთეთ გთხოვთ გააუქმოთ!!!");

        // Если пользователь подтвердил, отправляем запрос на сервер Flask
        if (userConfirmed) {
            var downloadUrl = `/download_manifest?date=${date}&where_from=${where_from}`;

            // Создаем временную ссылку для скачивания файла
            var a = document.createElement('a');
            a.href = downloadUrl;

            // Задаем имя файла
            a.download = 'manifest.xlsx';

            // Добавляем элемент в DOM и эмулируем клик для скачивания файла
            document.body.appendChild(a);
            a.click();

            // Удаляем элемент из DOM
            document.body.removeChild(a);
        }
    }
</script>

{% endblock %}
